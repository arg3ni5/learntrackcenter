import{u as U,e as w,d as N,l as T,j as a,L as M,D,c as $,C as k,A as B}from"./index-Cui4C6id.js";import{r as i,f as G}from"./vendor-react-BWjxQFbR.js";import{b as R}from"./courseService-CXf6yShE.js";import{g as O,e as q}from"./studentService-BDxH82um.js";import{c as z,b as H,e as C,u as J,w as K,f as Q}from"./vendor-firebase-CpkMzyVB.js";import{u as V}from"./useStudentCourses-CkeTLfEg.js";import"./vendor-ui-CZ9GI7ht.js";import"./vendor-utils-BDfVuDdi.js";import"./periodService-B8qW6QfF.js";const W=(s,e)=>{const[t,c]=i.useState(null),[o,n]=i.useState(!0),[l,g]=i.useState(null),{showNotification:r}=U(),[A]=w("availableTeachers",[]),f=async()=>{try{if(!e){console.error("Course ID is null or undefined");return}if(!s){console.error("Period ID is null or undefined");return}n(!0);const d=await R(s,e);if(d){const p=A.find(S=>S.id===d.teacherId);d.teacherName=p?p.name:"Unassigned Teacher"}c(d)}catch{g("Error loading course"),r("Error loading course","error"),console.error(`Error loading course ${e}`)}finally{n(!1)}};return i.useEffect(()=>{f()},[]),{course:t,loading:o,error:l,setError:g}},L=s=>{const{id:e,periodId:t}=s,[c,o]=i.useState([]),[n,l]=i.useState([]),[g,r]=i.useState(!0),[A,f]=i.useState(null),d=async()=>{try{r(!0);const S=await O(t,e);o(S)}catch{f("Error loading getStudentsInCourse")}finally{r(!1)}},p=async()=>{try{r(!0);const S=await q(t,e);l(S)}catch{f("Error loading students")}finally{r(!1)}};return i.useEffect(()=>{d()},[e]),{students:c,availableStudents:n,loadAvailableStudents:p,loading:g,error:A,loadStudents:d}},I=(s,e,t)=>`students/${s}/periods/${e}/courses/${t}`,X=async(s,e,t)=>{const c=`${I(s,e,t)}/assignments`,o=z(N,c);return(await H(o)).docs.map(l=>{const{title:g}=l.data(),{grade:r,percentage:A,percentageMax:f}=l.data();return{id:l.id,title:g,grade:r||0,gradeMax:100,percentage:A||0,percentageMax:f}})},Y=async(s,e)=>{await T(s,e)},Z=async(s,e,t,c,o)=>{const n=`${I(s,e,t)}/assignments/${c}`;console.log({url:n,studentId:s,courseId:t,assignmentId:c,updatedAssignment:o});const l=C(N,n);await J(l,o)},_=async(s,e,t,c)=>{const o=K(N);c.forEach(n=>{const{id:l,...g}=n,r=C(N,`${I(s,e,t)}/assignments/${l}`);o.update(r,g)}),await o.commit()},ee=async(s,e,t,c)=>{const o=C(N,`${I(s,e,t)}/assignments/${c}`);await Q(o)},te=s=>{const{studentId:e,periodId:t,periodCourseId:c,courseId:o}=s,[n,l]=i.useState([]),[g,r]=i.useState(!1),[A,f]=i.useState(null),d=i.useCallback(async()=>{r(!0);try{const u=await X(e,t,c);l(u)}catch(u){f(u instanceof Error?u.message:"Error al cargar las calificaciones")}finally{r(!1)}},[e]);i.useEffect(()=>{d()},[e]);const p=i.useCallback(async()=>{r(!0);try{await Y(t,c)}catch(u){f(u instanceof Error?u.message:"Error adding assignment")}finally{r(!1)}},[e,t,o,d,r]),S=i.useCallback(async(u,h)=>{r(!0);try{if(c){const{percentage:m,grade:b}=h,y=(!m||m===0)&&b?j(h):Number(m);console.log(y);const v={...h,grade:b!==void 0?Number(b):void 0,percentage:y};await Z(e,t,c,u,v)}else f("Course or course ID is missing");await d()}catch(m){console.error(m),f(m instanceof Error?m.message:"Error updating assignment")}finally{r(!1)}},[e,o,d,r]),E=i.useCallback(async u=>{r(!0);try{if(c){const h=P(u);h.length>0&&(await _(e,t,c,h),await d())}else f("Course or course ID is missing")}catch(h){f(h instanceof Error?h.message:"Error updating assignment")}finally{r(!1)}},[e,o,d,r]),x=i.useCallback(async u=>{r(!0);try{await ee(e,t,o,u),await d()}catch(h){f(h instanceof Error?h.message:"Error deleting assignment")}finally{r(!1)}},[e,o,d,r]),j=u=>{const{gradeMax:h,grade:m,percentageMax:b}=u;if(m===100&&b)return b;const y=h??100,v=m/y,F=v*b;return console.log({maxScore:y,proportion:v,contribution:F}),F},P=u=>{const h=[];return n&&n.map(m=>{const b=u[m.id];if(console.log({assignment:m,assignmentsRecord:u}),b){const{grade:y}=b;let v=m.percentage||0;console.log({"grade !== undefined":y!==void 0,"grade !== assignment.grade":y!==m.grade}),y!==void 0&&y!==m.grade&&(v=j({...m,...b}),console.log(v)),h.push({...m,...b,percentage:v})}return m}),console.log({assignmentsArray:h,assignmentsRecord:u}),h};return{studentAssignment:n,loadAssignments:d,handleLoadAvalaibleAssignment:p,loading:g,error:A,handleUpdateAssignment:S,handleUpdateAssignments:E,handleDeleteAssignment:x}},se=({studentId:s,periodId:e,periodCourseId:t,courseId:c})=>{const[o,n]=w("currentAssignment",null),{studentAssignment:l,loading:g,handleUpdateAssignment:r,handleUpdateAssignments:A}=te({studentId:s,periodId:e,periodCourseId:t,courseId:c}),f=i.useMemo(()=>l.reduce((x,j)=>x+j.percentage,0),[l]),d=[{name:"title",placeholder:"Assignment"},{name:"percentage",placeholder:"Percentage",type:"number"},{name:"grade",placeholder:"Grade",type:"number"}],p=async x=>{console.log(x)},S=x=>{n(x)},E=x=>{A(x)};return g?a.jsx(M,{type:"spinner",className:"item h30vh"}):a.jsx(a.Fragment,{children:a.jsxs("div",{className:"item",children:[a.jsxs("div",{children:["Total Percentage: ",f,"%"]}),!g&&a.jsx(D,{alias:"AssignmentsManager",fields:d,items:l,ableFilter:!0,showForm:!1,ableForm:!0,initialFormData:o,loading:g,handlers:{onItemUpdated:r,onItemDeleted:p,onSelect:S,onItemsUpdated:E}})]})})},ae=({periodCourse:s,periodId:e})=>{const{setIsLoading:t}=$(),{students:c,loading:o}=L(s),[n,l]=w("selectedStudent",null),g=[{name:"fullName",placeholder:"Full Name",view:!0},{name:"identificationNumber",placeholder:"Identification Number"},{name:"email",placeholder:"Email Address"},{name:"grade",placeholder:"grade",view:!0}];return i.useEffect(()=>{t(o)},[o,t]),o?a.jsx(M,{type:"spinner",className:"item h30vh"}):a.jsxs(a.Fragment,{children:[a.jsx("h2",{}),a.jsxs("div",{className:"container",children:[a.jsx("div",{children:a.jsx(D,{alias:"CourseStudentsManager",fields:g,items:c,initialFormData:n,showForm:!1,ableForm:!1,ableFilter:!0,ableImport:!1,clearFormAfterAdd:!0,handlers:{onSelect:l},loading:o})}),(n==null?void 0:n.id)&&s.id&&e&&a.jsx(se,{studentId:n==null?void 0:n.id,periodId:e,courseId:s.courseId,periodCourseId:s.id})]})]})},ne=[{name:"identificationNumber",placeholder:"Identification"},{name:"email",placeholder:"Email Address"}],re=({student:s,onDelete:e})=>a.jsx(a.Fragment,{children:a.jsx(k,{titleName:"fullName",fields:ne,data:s,handlers:{onDelete:e}})}),oe=({periodCourse:s,periodId:e})=>{const{setIsLoading:t}=$(),{availableStudents:c,loadAvailableStudents:o,loading:n,error:l}=L(s),{handleAddCourse:g}=V(e),[r,A]=i.useState(null);i.useEffect(()=>{o()},[]);const f=[{name:"fullName",placeholder:"Full Name",view:!0},{name:"identificationNumber",placeholder:"Identification Number"},{name:"email",placeholder:"Email Address"}],d=async()=>{if(r&&s){const{id:p,duration:S,hours:E,...x}=s,j={...x,id:p,courseId:p,periodId:e,periodCourseId:p,status:"Not Started",finalGrade:0,assignmentsIds:[]};console.log(j),await g(r.id,j),await o()}};return i.useEffect(()=>{t(n)},[n,t]),a.jsxs("div",{className:"",children:[a.jsx("h2",{}),r&&a.jsx(re,{student:r}),r&&a.jsx("button",{className:"edit-button",onClick:d,children:"Assign course"}),a.jsx(D,{fields:f,items:c,showForm:!1,ableFilter:!0,ableForm:!1,ableImport:!1,clearFormAfterAdd:!0,handlers:{onSelect:A},loading:n}),l&&a.jsx("div",{className:"error",children:l})]})},ce=({periodId:s,periodCourse:e})=>{const[t,c]=w("activeSection","course"),o=[{name:"name",placeholder:"name"},{name:"description",placeholder:"description"},{name:"duration",placeholder:"duration"},{name:"hours",placeholder:"hours"},{name:"status",placeholder:"status"},{name:"assignmentsIds",placeholder:"assignments",type:"array"},{name:"teacherName",placeholder:"teacherName"}],n=l=>{c(l===t?"":l)};return a.jsxs(a.Fragment,{children:[a.jsxs("h1",{className:"title",children:[e==null?void 0:e.name," Course Manage"]}),a.jsxs("div",{className:"section-buttons",children:[a.jsx("button",{onClick:()=>n("course"),className:t==="course"?"button active":"",children:"Course Details"}),a.jsx("button",{onClick:()=>n("assignments"),className:t==="assignments"?"button active":"",children:"Assignments"}),a.jsx("button",{onClick:()=>n("students"),className:t==="students"?"button active":"",children:"Students"}),a.jsx("button",{onClick:()=>n("avalibleStudents"),className:t==="avalibleStudents"?"button active":"",children:"Avalible Students"})]}),t==="course"&&e&&a.jsx(k,{titleName:"name",fields:o,data:e}),t==="assignments"&&a.jsx(B,{courseId:e==null?void 0:e.id,periodId:s}),t==="students"&&a.jsx(ae,{periodCourse:e,periodId:s}),t==="avalibleStudents"&&a.jsx(oe,{periodCourse:e,periodId:s})]})},Se=()=>{const{periodId:s,courseId:e}=G(),{loading:t,course:c}=W(s,e);return a.jsx(a.Fragment,{children:!t&&c&&a.jsx(ce,{periodId:s,periodCourse:c})})};export{Se as default};
