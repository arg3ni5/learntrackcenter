import{u as k,e as w,d as E,l as R,j as s,L as C,D,C as M,c as L,m as B,F as G,n as O,o as V}from"./index-BItWtqw2.js";import{r as d,f as q}from"./vendor-react-BWjxQFbR.js";import{b as z}from"./courseService-ir0hzEPD.js";import{g as H,e as J}from"./studentService-gnMmYG-n.js";import{c as K,b as Q,e as F,u as W,w as X,f as Y}from"./vendor-firebase-IMjs4EV5.js";import{u as U}from"./useStudentCourses-C1L-eXxW.js";import"./vendor-ui-CZ9GI7ht.js";import"./vendor-utils-BDfVuDdi.js";import"./periodService-3cjU1pu1.js";const Z=(t,e)=>{const[a,c]=d.useState(null),[o,i]=d.useState(!0),[r,l]=d.useState(null),{showNotification:n}=k(),[p]=w("availableTeachers",[]),m=async()=>{try{if(!e){console.error("Course ID is null or undefined");return}if(!t){console.error("Period ID is null or undefined");return}i(!0);const u=await z(t,e);if(u){const A=p.find(S=>S.id===u.teacherId);u.teacherName=A?A.name:"Unassigned Teacher"}c(u)}catch{l("Error loading course"),n("Error loading course","error"),console.error(`Error loading course ${e}`)}finally{i(!1)}};return d.useEffect(()=>{m()},[]),{course:a,loading:o,error:r,setError:l}},$=t=>{const{id:e,periodId:a}=t,[c,o]=d.useState([]),[i,r]=d.useState([]),[l,n]=d.useState(!0),[p,m]=d.useState(null),u=async()=>{try{n(!0);const S=await H(a,e);o(S)}catch{m("Error loading getStudentsInCourse")}finally{n(!1)}},A=async()=>{try{n(!0);const S=await J(a,e);r(S)}catch{m("Error loading students")}finally{n(!1)}};return d.useEffect(()=>{u()},[e]),{students:c,availableStudents:i,loadAvailableStudents:A,loading:l,error:p,loadStudents:u}},I=(t,e,a)=>`students/${t}/periods/${e}/courses/${a}`,_=async(t,e,a)=>{const c=`${I(t,e,a)}/assignments`,o=K(E,c);return(await Q(o)).docs.map(r=>{const{title:l}=r.data(),{grade:n,percentage:p,percentageMax:m}=r.data();return{id:r.id,title:l,grade:n||0,gradeMax:100,percentage:p||0,percentageMax:m}})},ee=async(t,e)=>{await R(t,e)},se=async(t,e,a,c,o)=>{const i=`${I(t,e,a)}/assignments/${c}`,r=F(E,i);await W(r,o)},te=async(t,e,a,c)=>{const o=X(E);c.forEach(i=>{const{id:r,...l}=i,n=F(E,`${I(t,e,a)}/assignments/${r}`);o.update(n,l)}),await o.commit()},ae=async(t,e,a,c)=>{const o=F(E,`${I(t,e,a)}/assignments/${c}`);await Y(o)},ne=t=>{const{studentId:e,periodId:a,periodCourseId:c,courseId:o}=t,[i,r]=d.useState([]),[l,n]=d.useState(!1),[p,m]=d.useState(null),u=d.useCallback(async()=>{n(!0);try{const f=await _(e,a,c);r(f)}catch(f){m(f instanceof Error?f.message:"Error al cargar las calificaciones")}finally{n(!1)}},[e]);d.useEffect(()=>{u()},[e]);const A=d.useCallback(async()=>{n(!0);try{await ee(a,c)}catch(f){m(f instanceof Error?f.message:"Error adding assignment")}finally{n(!1)}},[e,a,o,u,n]),S=d.useCallback(async(f,h)=>{n(!0);try{if(c){const{percentage:g,grade:b}=h,y=(!g||g===0)&&b?j(h):Number(g),N={...h,grade:b!==void 0?Number(b):void 0,percentage:y};await se(e,a,c,f,N)}else m("Course or course ID is missing");await u()}catch(g){console.error(g),m(g instanceof Error?g.message:"Error updating assignment")}finally{n(!1)}},[e,o,u,n]),v=d.useCallback(async f=>{n(!0);try{if(c){const h=T(f);h.length>0&&(await te(e,a,c,h),await u())}else m("Course or course ID is missing")}catch(h){m(h instanceof Error?h.message:"Error updating assignment")}finally{n(!1)}},[e,o,u,n]),x=d.useCallback(async f=>{n(!0);try{await ae(e,a,o,f),await u()}catch(h){m(h instanceof Error?h.message:"Error deleting assignment")}finally{n(!1)}},[e,o,u,n]),j=f=>{const{gradeMax:h,grade:g,percentageMax:b}=f;return g===100&&b?b:g/(h??100)*b},T=f=>{const h=[];return i&&i.map(g=>{const b=f[g.id];if(b){const{grade:y}=b;let N=g.percentage||0;console.log({"grade !== undefined":y!==void 0,"grade !== assignment.grade":y!==g.grade}),y!==void 0&&y!==g.grade&&(N=j({...g,...b})),h.push({...g,...b,percentage:N})}return g}),h};return{studentAssignment:i,loadAssignments:u,handleLoadAvalaibleAssignment:A,loading:l,error:p,handleUpdateAssignment:S,handleUpdateAssignments:v,handleDeleteAssignment:x}},re=({studentId:t,periodId:e,periodCourseId:a,courseId:c})=>{const[o,i]=w("currentAssignment",null),{studentAssignment:r,loading:l,handleUpdateAssignment:n,handleUpdateAssignments:p}=ne({studentId:t,periodId:e,periodCourseId:a,courseId:c}),m=d.useMemo(()=>r.reduce((x,j)=>x+j.percentage,0),[r]),u=[{name:"title",placeholder:"Assignment"},{name:"percentage",placeholder:"Percentage",type:"number"},{name:"grade",placeholder:"Grade",type:"number"}],A=async x=>{console.log(x)},S=x=>{i(x)},v=x=>{p(x)};return l?s.jsx(C,{type:"spinner",className:"item h30vh"}):s.jsx(s.Fragment,{children:s.jsxs("div",{className:"item",children:[s.jsxs("div",{children:["Total Percentage: ",m,"%"]}),!l&&s.jsx(D,{alias:"AssignmentsManager",fields:u,items:r,ableFilter:!0,showForm:!1,ableForm:!0,initialFormData:o,loading:l,handlers:{onItemUpdated:n,onItemDeleted:A,onSelect:S,onItemsUpdated:v}})]})})},oe=[{name:"identificationNumber",placeholder:"Identification"},{name:"email",placeholder:"Email Address"}],P=({student:t,onDelete:e})=>s.jsx(s.Fragment,{children:s.jsx(M,{titleName:"fullName",fields:oe,data:t,handlers:{onDelete:e}})}),ce=({periodCourse:t,periodId:e})=>{const{setIsLoading:a}=L(),{students:c,loading:o}=$(t),{handleDeleteCourse:i}=U(e),[r,l]=w("selectedStudent",null),n=[{name:"fullName",placeholder:"Full Name",view:!0},{name:"identificationNumber",placeholder:"Identification Number"},{name:"email",placeholder:"Email Address"},{name:"grade",placeholder:"grade",view:!0}],p=async m=>{await i(m,t.id,e)};return d.useEffect(()=>{a(o)},[o,a]),o?s.jsx(C,{type:"spinner",className:"item h30vh"}):s.jsxs(s.Fragment,{children:[r&&s.jsx(P,{student:r}),s.jsx("h2",{}),s.jsx("div",{className:"container px-0",children:s.jsxs("div",{className:"item",children:[s.jsx(D,{title:"STUDENTS",alias:"CourseStudentsManager",fields:n,items:c,initialFormData:r,showForm:!1,ableForm:!1,ableFilter:!0,ableImport:!1,clearFormAfterAdd:!0,handlers:{onSelect:l,onItemDeleted:p},loading:o}),(r==null?void 0:r.id)&&t.id&&e&&s.jsx(re,{studentId:r==null?void 0:r.id,periodId:e,courseId:t.courseId,periodCourseId:t.id})]})})]})},le=({periodCourse:t,periodId:e})=>{const{setIsLoading:a}=L(),{availableStudents:c,loadAvailableStudents:o,loading:i,error:r}=$(t),{handleAddCourse:l}=U(e),[n,p]=d.useState(null);d.useEffect(()=>{o()},[]);const m=[{name:"fullName",placeholder:"Full Name",view:!0},{name:"identificationNumber",placeholder:"Identification Number"},{name:"email",placeholder:"Email Address"}],u=async()=>{if(n&&t){const{id:A,courseId:S,name:v,description:x}=t,j={periodCourseId:A,courseId:S,periodId:e,name:v,description:x,status:"Not Started",finalGrade:0,assignmentsIds:[]};await l(n.id,j),await o()}};return d.useEffect(()=>{a(i)},[i,a]),s.jsxs("div",{className:"",children:[s.jsx("h2",{}),n&&s.jsx(P,{student:n}),n&&s.jsx("button",{className:"edit-button",onClick:u,children:"Assign course"}),s.jsx(D,{title:"AVAILABLE STUDENTS",fields:m,items:c,showForm:!1,ableFilter:!0,ableForm:!1,ableImport:!1,clearFormAfterAdd:!0,handlers:{onSelect:p},loading:i}),r&&s.jsx("div",{className:"error",children:r})]})},ie=({periodId:t,periodCourse:e})=>{const[a,c]=w("activeSection","course"),o=[{name:"description",placeholder:"description"},{name:"duration",placeholder:"duration"},{name:"hours",placeholder:"hours"},{name:"status",placeholder:"status"},{name:"assignmentsIds",placeholder:"assignments",type:"array"},{name:"teacherName",placeholder:"teacherName"}],i=[{id:"assignments",label:"Course Assignments",icon:s.jsx(G,{})},{id:"students",label:"Enrolled Students",icon:s.jsx(O,{})},{id:"availableStudents",label:"Available Students",icon:s.jsx(V,{})}],r=l=>{c(l===a?"":l)};return s.jsxs(s.Fragment,{children:[s.jsxs("h1",{className:"title",children:[e==null?void 0:e.name," Course Manage"]}),s.jsx("div",{className:"view-toggle tabs",children:i.map(({id:l,label:n,icon:p})=>s.jsxs("button",{onClick:()=>r(l),className:`tab ${a===l?"active":""}`,children:[p," ",s.jsx("span",{className:"d-none ",children:n})]},l))}),s.jsx(M,{fields:o,data:e}),s.jsxs("div",{className:"container px-0",children:[a==="assignments"&&s.jsx(B,{courseId:e==null?void 0:e.id,periodId:t}),a==="students"&&s.jsx(ce,{periodCourse:e,periodId:t}),a==="availableStudents"&&s.jsx(le,{periodCourse:e,periodId:t})]})]})},Ae=()=>{const{periodId:t,courseId:e}=q(),{loading:a,course:c}=Z(t,e);return s.jsx(s.Fragment,{children:!a&&c&&s.jsx(ie,{periodId:t,periodCourse:c})})};export{Ae as default};
