import{r as d,d as U,o as I,j as n,C as F,h as T,m as N,n as B,t as R,k as D,v as G,w as q,l as O,B as C,f as k,A as z,q as H}from"./index-BozJdoqh.js";import{b as J}from"./courseService-BKmjs8rX.js";import{g as K,h as Q,e as V}from"./useStudentCourses-D2S5OMls.js";import"./periodService-COUu7smY.js";const W=(s,e)=>{const[t,o]=d.useState(null),[c,l]=d.useState(!0),[r,g]=d.useState(null),{showNotification:a}=U(),[A]=I("availableTeachers",[]),f=async()=>{try{if(!e){console.error("Course ID is null or undefined");return}if(!s){console.error("Period ID is null or undefined");return}l(!0);const u=await J(s,e);if(u){const p=A.find(b=>b.id===u.teacherId);u.teacherName=p?p.name:"Unknown Teacher"}o(u)}catch{g("Error loading course"),a("Error loading course","error"),console.error(`Error loading course ${e}`)}finally{l(!1)}};return d.useEffect(()=>{f()},[]),{course:t,loading:c,error:r,setError:g}},$=s=>{const{id:e,periodId:t}=s,[o,c]=d.useState([]),[l,r]=d.useState([]),[g,a]=d.useState(!0),[A,f]=d.useState(null),u=async()=>{try{a(!0),console.log("loadStudents",s);const b=await K(t,e);c(b)}catch{f("Error loading getStudentsInCourse")}finally{a(!1)}},p=async()=>{try{a(!0);const b=await Q(t,e);r(b)}catch{f("Error loading students")}finally{a(!1)}};return d.useEffect(()=>{u()},[e]),{students:o,availableStudents:l,loadAvailableStudents:p,loading:g,error:A,loadStudents:u}},X=[{name:"identificationNumber",placeholder:"Identification"},{name:"email",placeholder:"Email Address"}],M=({student:s,onDelete:e})=>n.jsx(n.Fragment,{children:n.jsx(F,{titleName:"fullName",fields:X,data:s,onDelete:e})}),w=(s,e,t)=>`students/${s}/periods/${e}/courses/${t}`,Y=async(s,e,t)=>{const o=`${w(s,e,t)}/assignments`;console.log({url:o,studentId:s,periodId:e,courseId:t});const c=T(N,o);return(await B(c)).docs.map(r=>{const{title:g}=r.data(),{grade:a,percentage:A,percentageMax:f}=r.data();return{id:r.id,title:g,grade:a||0,gradeMax:100,percentage:A||0,percentageMax:f}})},Z=async(s,e)=>{await R(s,e)},_=async(s,e,t,o,c)=>{const l=`${w(s,e,t)}/assignments/${o}`;console.log({url:l,studentId:s,courseId:t,assignmentId:o,updatedAssignment:c});const r=D(N,l);await G(r,c)},ee=async(s,e,t,o)=>{const c=q(N);o.forEach(l=>{const{id:r,...g}=l,a=D(N,`${w(s,e,t)}/assignments/${r}`);c.update(a,g)}),await c.commit()},te=async(s,e,t,o)=>{const c=D(N,`${w(s,e,t)}/assignments/${o}`);await O(c)},se=s=>{const{studentId:e,periodId:t,periodCourseId:o,courseId:c}=s,[l,r]=d.useState([]),[g,a]=d.useState(!1),[A,f]=d.useState(null),u=d.useCallback(async()=>{a(!0);try{const m=await Y(e,t,o);r(m)}catch(m){f(m instanceof Error?m.message:"Error al cargar las calificaciones")}finally{a(!1)}},[e]);d.useEffect(()=>{u()},[e]);const p=d.useCallback(async()=>{a(!0);try{await Z(t,o)}catch(m){f(m instanceof Error?m.message:"Error adding assignment")}finally{a(!1)}},[e,t,c,u,a]),b=d.useCallback(async(m,h)=>{a(!0);try{if(o){const{percentage:i,grade:S}=h,v=(!i||i===0)&&S?y(h):Number(i);console.log(v);const j={...h,grade:S!==void 0?Number(S):void 0,percentage:v};await _(e,t,o,m,j)}else f("Course or course ID is missing");await u()}catch(i){console.error(i),f(i instanceof Error?i.message:"Error updating assignment")}finally{a(!1)}},[e,c,u,a]),E=d.useCallback(async m=>{a(!0);try{o?await ee(e,t,o,P(m)):f("Course or course ID is missing"),await u()}catch(h){f(h instanceof Error?h.message:"Error updating assignment")}finally{a(!1)}},[e,c,u,a]),x=d.useCallback(async m=>{a(!0);try{await te(e,t,c,m),await u()}catch(h){f(h instanceof Error?h.message:"Error deleting assignment")}finally{a(!1)}},[e,c,u,a]),y=m=>{const h=m.gradeMax??100,i=m.grade/h,S=i*m.percentageMax;return console.log(h,i,S),S},L=m=>{r(h=>h.map(i=>{const S=m[i.id];if(S){const{grade:v}=S;let j=i.percentage||0;return v!==void 0&&v!==i.grade&&(j=y({...i,...S})),{...i,...S,percentage:j}}return i}))},P=m=>{const h=[];return l&&l.map(i=>{const S=m[i.id];if(S){const{grade:v}=S;let j=i.percentage||0;v!==void 0&&v!==i.grade&&(j=y({...i,...S})),h.push({...i,...S,percentage:j})}return i}),h};return{studentAssignment:l,loadAssignments:u,handleLoadAvalaibleAssignment:p,loading:g,error:A,handleUpdateAssignment:b,handleUpdateAssignments:E,handleDeleteAssignment:x,updateAssignments:L}},ae=({studentId:s,periodId:e,periodCourseId:t,courseId:o})=>{const[c,l]=I("currentAssignment",null),{studentAssignment:r,loading:g,handleUpdateAssignment:a,handleUpdateAssignments:A}=se({studentId:s,periodId:e,periodCourseId:t,courseId:o}),f=d.useMemo(()=>r.reduce((x,y)=>x+y.percentage,0),[r]);if(g)return n.jsx("div",{children:"Loading assignments..."});const u=[{name:"title",placeholder:"Assignment"},{name:"percentage",placeholder:"Percentage",type:"number"},{name:"grade",placeholder:"Grade",type:"number"}],p=async x=>{console.log(x)},b=x=>{l(x)},E=x=>{A(x)};return n.jsxs(n.Fragment,{children:[n.jsxs("div",{children:["Total Percentage: ",f,"%"]}),!g&&n.jsx(C,{fields:u,items:r,onItemUpdated:a,onItemDeleted:p,ableFilter:!0,showForm:!1,ableForm:!0,initialFormData:c,onSelect:b,onItemsUpdated:E,loading:g})]})},ne=({periodCourse:s,periodId:e})=>{const{setIsLoading:t}=k(),{students:o,loading:c,error:l}=$(s),[r,g]=d.useState(null),a=[{name:"fullName",placeholder:"Full Name",view:!0},{name:"identificationNumber",placeholder:"Identification Number"},{name:"email",placeholder:"Email Address"}];return d.useEffect(()=>{t(c)},[c,t]),n.jsxs("div",{className:"",children:[n.jsx("h2",{}),r&&n.jsx(M,{student:r}),(r==null?void 0:r.id)&&s.id&&e&&n.jsx(ae,{studentId:r==null?void 0:r.id,periodId:e,courseId:s.courseId,periodCourseId:s.id}),n.jsx(C,{fields:a,items:o,showForm:!1,ableForm:!1,ableFilter:!0,ableImport:!1,clearFormAfterAdd:!0,onSelect:g,loading:c}),l&&n.jsx("div",{className:"error",children:l})]})},re=({periodCourse:s,periodId:e})=>{const{setIsLoading:t}=k(),{availableStudents:o,loadAvailableStudents:c,loading:l,error:r}=$(s),{handleAddCourse:g}=V(e),[a,A]=d.useState(null);d.useEffect(()=>{c()},[]);const f=[{name:"fullName",placeholder:"Full Name",view:!0},{name:"identificationNumber",placeholder:"Identification Number"},{name:"email",placeholder:"Email Address"}],u=async()=>{if(a&&s){const{id:p,duration:b,hours:E,...x}=s,y={...x,id:p,courseId:p,periodId:e,periodCourseId:p,status:"Not Started",finalGrade:0,assignmentsIds:[]};console.log(y),await g(a.id,y),await c()}};return d.useEffect(()=>{t(l)},[l,t]),n.jsxs("div",{className:"",children:[n.jsx("h2",{}),a&&n.jsx(M,{student:a}),a&&n.jsx("button",{className:"edit-button",onClick:u,children:"Assign course"}),n.jsx(C,{fields:f,items:o,showForm:!1,ableFilter:!0,ableForm:!1,ableImport:!1,clearFormAfterAdd:!0,onSelect:A,loading:l}),r&&n.jsx("div",{className:"error",children:r})]})},oe=({periodId:s,periodCourse:e})=>{const[t,o]=I("activeSection","course"),c=[{name:"name",placeholder:"name"},{name:"description",placeholder:"description"},{name:"duration",placeholder:"duration"},{name:"hours",placeholder:"hours"},{name:"status",placeholder:"status"},{name:"assignmentsIds",placeholder:"assignments",type:"array"},{name:"teacherName",placeholder:"teacherName"}],l=r=>{o(r===t?"":r)};return n.jsxs(n.Fragment,{children:[n.jsxs("h1",{className:"title",children:[e==null?void 0:e.name," Course Manage"]}),n.jsxs("div",{className:"section-buttons",children:[n.jsx("button",{onClick:()=>l("course"),className:t==="course"?"active":"",children:"Course Details"}),n.jsx("button",{onClick:()=>l("assignments"),className:t==="assignments"?"active":"",children:"Assignments"}),n.jsx("button",{onClick:()=>l("students"),className:t==="students"?"active":"",children:"Students"}),n.jsx("button",{onClick:()=>l("avalibleStudents"),className:t==="avalibleStudents"?"active":"",children:"Avalible Students"})]}),t==="course"&&e&&n.jsx(F,{titleName:"name",fields:c,data:e}),t==="assignments"&&n.jsx(z,{courseId:e==null?void 0:e.id,periodId:s}),t==="students"&&n.jsx(ne,{periodCourse:e,periodId:s}),t==="avalibleStudents"&&n.jsx(re,{periodCourse:e,periodId:s})]})},ue=()=>{const{periodId:s,courseId:e}=H(),{loading:t,course:o}=W(s,e);return n.jsx(n.Fragment,{children:!t&&o&&n.jsx(oe,{periodId:s,periodCourse:o})})};export{ue as default};
