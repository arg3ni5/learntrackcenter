import{r as i}from"./vendor-react-BWjxQFbR.js";import{d as f,c as U,e as R,u as j,r as B}from"./index-BktWWyx6.js";import{c as y,a as $,d as p,s as x,u as F,f as M,w as k,q as z,j as A,e as I,i as G}from"./vendor-firebase-firestore-B5VfNmRa.js";import{f as H}from"./periodService-CbBRYdfE.js";const L=(r,t)=>`students/${r}/periods/${t}/courses`,J=async(r,t)=>{const e=y(f,L(r,t));return(await $(e)).docs.map(l=>({id:l.id,...l.data()}))},K=async(r,t)=>{try{const{periodId:e,periodCourseId:a}=t;if(!r)throw new Error("Student ID is null or undefined");if(!e)throw new Error("Period ID is null or undefined");if(!a)throw new Error("Course ID is null or undefined");const l=`students/${r}/periods/${e}/courses`,d=p(f,l,a);await x(d,t),console.log("Course added with ID: ",a);const g=y(f,"enrollments"),h=p(g);await x(h,{studentId:r,periodId:e,courseId:a});const s=p(f,`periods/${e}/courses`,a);await F(s,{enrolledStudents:M(r)});const S=y(f,`periods/${e}/courses/${a}/assignments`),D=await $(S),v=y(d,"assignments"),C=k(f);D.docs.forEach(u=>{const{title:P,contributionPercentage:c}=u.data(),{grade:E,percentage:b}=u.data(),m={id:u.id,assignmentId:u.id,title:P,grade:E||0,percentage:b||0,percentageMax:Number(c)},N=p(v,u.id);C.set(N,m)}),await C.commit(),console.log("Assignments added successfully")}catch(e){throw console.error("Error adding course: ",e),new Error("Failed to add course")}},O=async(r,t,e)=>{const a=y(f,"enrollments"),l=z(a,A("periodId","==",t),A("courseId","==",e),A("studentId","==",r)),d=await $(l);if(d.empty)console.error("Enrollment not found");else{const s=d.docs[0];await I(s.ref)}const g=p(f,L(r,t),e);if((await G(g)).exists())await I(g);else throw new Error("Course not found")},Y=r=>{const{setIsLoading:t}=U(),[e,a]=R("selectedPeriodId",null),[l]=i.useState([]),[d,g]=i.useState([]),[h,s]=i.useState(!0),[S,D]=i.useState(null),[v,C]=i.useState([]),[u,P]=R("availablePeriods",[]),{showNotification:c}=j();i.useEffect(()=>{t(h)},[h,t]);const E=async()=>{if(u.length===0)try{s(!0);const o=await H();P(o)}catch{D("Error fetching available periods"),c("Error fetching available periods","error")}finally{s(!1)}},b=async o=>{try{if(s(!0),o){a(o);const n=await B(o);C(n)}else C([])}catch{c("Error fetching available courses","error")}finally{s(!1)}},m=async o=>{try{if(!e)return;s(!0);const n=await J(o,e);g(n)}catch{c("Error fetching courses","error")}finally{s(!1)}};return i.useEffect(()=>{E()},[]),i.useEffect(()=>{r&&m(r)},[r,e]),i.useEffect(()=>{e&&b(e)},[e]),{loading:h,error:S,courses:l,studentCourses:d,availablePeriods:u,handleAddCourse:async(o,n)=>{try{if(!n.periodCourseId){console.error("handleAddCourse","Not period selected"),c("Not period selected","error");return}if(d.filter(w=>w.id===n.periodCourseId).length>0){c("Course already added","error");return}s(!0),await K(o,n),m(o)}catch{c("Error adding course","error")}finally{s(!1)}},handleDeleteCourse:async(o,n,w)=>{if(!w){console.error("handleDeleteCourse","Not period selected"),c("Not period selected","error");return}try{if(!n)return;s(!0),await O(o,w,n),m(o)}catch(q){console.error(q),D("Error deleting course"),c("Error deleting course","error")}finally{s(!1)}},availableCourses:v,loadAvailableCourses:b,loadAvailablePeriods:E,setPeriodId:a}};export{Y as u};
