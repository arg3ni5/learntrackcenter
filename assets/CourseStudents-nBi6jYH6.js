import{r as i,a as U,o as E,f as T,h as N,k as B,t as G,l as D,v as R,w as O,m as q,j as a,L as M,D as C,e as k,C as $,A as z,n as H}from"./index-BaZKZUog.js";import{b as J}from"./courseService-D0fa1hNt.js";import{g as K,e as Q}from"./studentService-DdMT3nti.js";import{u as V}from"./useStudentCourses-CvS9slwc.js";import"./periodService-B9GLDZYZ.js";const W=(s,e)=>{const[t,c]=i.useState(null),[o,n]=i.useState(!0),[l,g]=i.useState(null),{showNotification:r}=U(),[A]=E("availableTeachers",[]),h=async()=>{try{if(!e){console.error("Course ID is null or undefined");return}if(!s){console.error("Period ID is null or undefined");return}n(!0);const d=await J(s,e);if(d){const S=A.find(p=>p.id===d.teacherId);d.teacherName=S?S.name:"Unknown Teacher"}c(d)}catch{g("Error loading course"),r("Error loading course","error"),console.error(`Error loading course ${e}`)}finally{n(!1)}};return i.useEffect(()=>{h()},[]),{course:t,loading:o,error:l,setError:g}},L=s=>{const{id:e,periodId:t}=s,[c,o]=i.useState([]),[n,l]=i.useState([]),[g,r]=i.useState(!0),[A,h]=i.useState(null),d=async()=>{try{r(!0);const p=await K(t,e);o(p)}catch{h("Error loading getStudentsInCourse")}finally{r(!1)}},S=async()=>{try{r(!0);const p=await Q(t,e);l(p)}catch{h("Error loading students")}finally{r(!1)}};return i.useEffect(()=>{d()},[e]),{students:c,availableStudents:n,loadAvailableStudents:S,loading:g,error:A,loadStudents:d}},I=(s,e,t)=>`students/${s}/periods/${e}/courses/${t}`,X=async(s,e,t)=>{const c=`${I(s,e,t)}/assignments`,o=T(N,c);return(await B(o)).docs.map(l=>{const{title:g}=l.data(),{grade:r,percentage:A,percentageMax:h}=l.data();return{id:l.id,title:g,grade:r||0,gradeMax:100,percentage:A||0,percentageMax:h}})},Y=async(s,e)=>{await G(s,e)},Z=async(s,e,t,c,o)=>{const n=`${I(s,e,t)}/assignments/${c}`;console.log({url:n,studentId:s,courseId:t,assignmentId:c,updatedAssignment:o});const l=D(N,n);await R(l,o)},_=async(s,e,t,c)=>{const o=O(N);c.forEach(n=>{const{id:l,...g}=n,r=D(N,`${I(s,e,t)}/assignments/${l}`);o.update(r,g)}),await o.commit()},ee=async(s,e,t,c)=>{const o=D(N,`${I(s,e,t)}/assignments/${c}`);await q(o)},te=s=>{const{studentId:e,periodId:t,periodCourseId:c,courseId:o}=s,[n,l]=i.useState([]),[g,r]=i.useState(!1),[A,h]=i.useState(null),d=i.useCallback(async()=>{r(!0);try{const u=await X(e,t,c);l(u)}catch(u){h(u instanceof Error?u.message:"Error al cargar las calificaciones")}finally{r(!1)}},[e]);i.useEffect(()=>{d()},[e]);const S=i.useCallback(async()=>{r(!0);try{await Y(t,c)}catch(u){h(u instanceof Error?u.message:"Error adding assignment")}finally{r(!1)}},[e,t,o,d,r]),p=i.useCallback(async(u,f)=>{r(!0);try{if(c){const{percentage:m,grade:b}=f,y=(!m||m===0)&&b?j(f):Number(m);console.log(y);const v={...f,grade:b!==void 0?Number(b):void 0,percentage:y};await Z(e,t,c,u,v)}else h("Course or course ID is missing");await d()}catch(m){console.error(m),h(m instanceof Error?m.message:"Error updating assignment")}finally{r(!1)}},[e,o,d,r]),w=i.useCallback(async u=>{r(!0);try{if(c){const f=P(u);f.length>0&&(await _(e,t,c,f),await d())}else h("Course or course ID is missing")}catch(f){h(f instanceof Error?f.message:"Error updating assignment")}finally{r(!1)}},[e,o,d,r]),x=i.useCallback(async u=>{r(!0);try{await ee(e,t,o,u),await d()}catch(f){h(f instanceof Error?f.message:"Error deleting assignment")}finally{r(!1)}},[e,o,d,r]),j=u=>{const{gradeMax:f,grade:m,percentageMax:b}=u;if(m===100&&b)return b;const y=f??100,v=m/y,F=v*b;return console.log({maxScore:y,proportion:v,contribution:F}),F},P=u=>{const f=[];return n&&n.map(m=>{const b=u[m.id];if(console.log({assignment:m,assignmentsRecord:u}),b){const{grade:y}=b;let v=m.percentage||0;console.log({"grade !== undefined":y!==void 0,"grade !== assignment.grade":y!==m.grade}),y!==void 0&&y!==m.grade&&(v=j({...m,...b}),console.log(v)),f.push({...m,...b,percentage:v})}return m}),console.log({assignmentsArray:f,assignmentsRecord:u}),f};return{studentAssignment:n,loadAssignments:d,handleLoadAvalaibleAssignment:S,loading:g,error:A,handleUpdateAssignment:p,handleUpdateAssignments:w,handleDeleteAssignment:x}},se=({studentId:s,periodId:e,periodCourseId:t,courseId:c})=>{const[o,n]=E("currentAssignment",null),{studentAssignment:l,loading:g,handleUpdateAssignment:r,handleUpdateAssignments:A}=te({studentId:s,periodId:e,periodCourseId:t,courseId:c}),h=i.useMemo(()=>l.reduce((x,j)=>x+j.percentage,0),[l]),d=[{name:"title",placeholder:"Assignment"},{name:"percentage",placeholder:"Percentage",type:"number"},{name:"grade",placeholder:"Grade",type:"number"}],S=async x=>{console.log(x)},p=x=>{n(x)},w=x=>{A(x)};return g?a.jsx(M,{type:"spinner",className:"item h30vh"}):a.jsx(a.Fragment,{children:a.jsxs("div",{className:"item",children:[a.jsxs("div",{children:["Total Percentage: ",h,"%"]}),!g&&a.jsx(C,{alias:"AssignmentsManager",fields:d,items:l,ableFilter:!0,showForm:!1,ableForm:!0,initialFormData:o,loading:g,handlers:{onItemUpdated:r,onItemDeleted:S,onSelect:p,onItemsUpdated:w}})]})})},ae=({periodCourse:s,periodId:e})=>{const{setIsLoading:t}=k(),{students:c,loading:o}=L(s),[n,l]=E("selectedStudent",null),g=[{name:"fullName",placeholder:"Full Name",view:!0},{name:"identificationNumber",placeholder:"Identification Number"},{name:"email",placeholder:"Email Address"},{name:"grade",placeholder:"grade",view:!0}];return i.useEffect(()=>{t(o)},[o,t]),o?a.jsx(M,{type:"spinner",className:"item h30vh"}):a.jsxs(a.Fragment,{children:[a.jsx("h2",{}),a.jsxs("div",{className:"container",children:[a.jsx("div",{children:a.jsx(C,{alias:"CourseStudentsManager",fields:g,items:c,initialFormData:n,showForm:!1,ableForm:!1,ableFilter:!0,ableImport:!1,clearFormAfterAdd:!0,handlers:{onSelect:l},loading:o})}),(n==null?void 0:n.id)&&s.id&&e&&a.jsx(se,{studentId:n==null?void 0:n.id,periodId:e,courseId:s.courseId,periodCourseId:s.id})]})]})},ne=[{name:"identificationNumber",placeholder:"Identification"},{name:"email",placeholder:"Email Address"}],re=({student:s,onDelete:e})=>a.jsx(a.Fragment,{children:a.jsx($,{titleName:"fullName",fields:ne,data:s,handlers:{onDelete:e}})}),oe=({periodCourse:s,periodId:e})=>{const{setIsLoading:t}=k(),{availableStudents:c,loadAvailableStudents:o,loading:n,error:l}=L(s),{handleAddCourse:g}=V(e),[r,A]=i.useState(null);i.useEffect(()=>{o()},[]);const h=[{name:"fullName",placeholder:"Full Name",view:!0},{name:"identificationNumber",placeholder:"Identification Number"},{name:"email",placeholder:"Email Address"}],d=async()=>{if(r&&s){const{id:S,duration:p,hours:w,...x}=s,j={...x,id:S,courseId:S,periodId:e,periodCourseId:S,status:"Not Started",finalGrade:0,assignmentsIds:[]};console.log(j),await g(r.id,j),await o()}};return i.useEffect(()=>{t(n)},[n,t]),a.jsxs("div",{className:"",children:[a.jsx("h2",{}),r&&a.jsx(re,{student:r}),r&&a.jsx("button",{className:"edit-button",onClick:d,children:"Assign course"}),a.jsx(C,{fields:h,items:c,showForm:!1,ableFilter:!0,ableForm:!1,ableImport:!1,clearFormAfterAdd:!0,handlers:{onSelect:A},loading:n}),l&&a.jsx("div",{className:"error",children:l})]})},ce=({periodId:s,periodCourse:e})=>{const[t,c]=E("activeSection","course"),o=[{name:"name",placeholder:"name"},{name:"description",placeholder:"description"},{name:"duration",placeholder:"duration"},{name:"hours",placeholder:"hours"},{name:"status",placeholder:"status"},{name:"assignmentsIds",placeholder:"assignments",type:"array"},{name:"teacherName",placeholder:"teacherName"}],n=l=>{c(l===t?"":l)};return a.jsxs(a.Fragment,{children:[a.jsxs("h1",{className:"title",children:[e==null?void 0:e.name," Course Manage"]}),a.jsxs("div",{className:"section-buttons",children:[a.jsx("button",{onClick:()=>n("course"),className:t==="course"?"button active":"",children:"Course Details"}),a.jsx("button",{onClick:()=>n("assignments"),className:t==="assignments"?"button active":"",children:"Assignments"}),a.jsx("button",{onClick:()=>n("students"),className:t==="students"?"button active":"",children:"Students"}),a.jsx("button",{onClick:()=>n("avalibleStudents"),className:t==="avalibleStudents"?"button active":"",children:"Avalible Students"})]}),t==="course"&&e&&a.jsx($,{titleName:"name",fields:o,data:e}),t==="assignments"&&a.jsx(z,{courseId:e==null?void 0:e.id,periodId:s}),t==="students"&&a.jsx(ae,{periodCourse:e,periodId:s}),t==="avalibleStudents"&&a.jsx(oe,{periodCourse:e,periodId:s})]})},ge=()=>{const{periodId:s,courseId:e}=H(),{loading:t,course:c}=W(s,e);return a.jsx(a.Fragment,{children:!t&&c&&a.jsx(ce,{periodId:s,periodCourse:c})})};export{ge as default};
