import{u as T,d as N,j as s,L as D,b as M,e as R,f as G,h as B,i as W}from"./index-g1SReERP.js";import{r as l,h as _,i as q}from"./vendor-react-CrVlFZLu.js";import{b as z}from"./courseService-JUTO4I2-.js";import{u as w,C as L}from"./Card-CSivsItZ.js";import{f as H,C as J}from"./CourseAssignmentsManager-Cahn1cf0.js";import{D as C,m as K}from"./DataManagementModule-3FyRWLSI.js";import{g as O,e as Q}from"./studentService-BMfmTLA_.js";import{_ as V,h as X,d as F,j as Y,W as Z,y as ee}from"./vendor-firebase-DPqF2cx7.js";import{u as $}from"./useStudentCourses-BW1e4n1x.js";import"./vendor-ui-Cz82L-V6.js";import"./vendor-utils-CMv371St.js";import"./periodCourseService-CGSWCgaZ.js";import"./periodService-CU21sGfe.js";const se=(a,e)=>{const[n,r]=l.useState(null),[o,c]=l.useState(!0),[i,m]=l.useState(null),{showNotification:t}=T(),[p]=w("availableTeachers",[]),d=async()=>{try{if(!e){console.error("Course ID is null or undefined");return}if(!a){console.error("Period ID is null or undefined");return}c(!0);const u=await z(a,e);if(u){const x=p.find(S=>S.id===u.teacherId);u.teacherName=x?x.name:"Unassigned Teacher"}r(u)}catch{m("Error loading course"),t("Error loading course","error"),console.error(`Error loading course ${e}`)}finally{c(!1)}};return l.useEffect(()=>{d()},[]),{course:n,loading:o,error:i,setError:m}},k=a=>{const{id:e,periodId:n}=a,[r,o]=l.useState([]),[c,i]=l.useState([]),[m,t]=l.useState(!0),[p,d]=l.useState(null),u=async()=>{try{t(!0);const S=await O(n,e);o(S)}catch{d("Error loading getStudentsInCourse")}finally{t(!1)}},x=async()=>{try{t(!0);const S=await Q(n,e);i(S)}catch{d("Error loading students")}finally{t(!1)}};return l.useEffect(()=>{u()},[e]),{students:r,availableStudents:c,loadAvailableStudents:x,loading:m,error:p,loadStudents:u}},I=(a,e,n)=>`students/${a}/periods/${e}/courses/${n}`,te=async(a,e,n)=>{const r=`${I(a,e,n)}/assignments`,o=V(N,r);return(await X(o)).docs.map(i=>{const{title:m}=i.data(),{grade:t,percentage:p,percentageMax:d}=i.data();return{id:i.id,title:m,grade:t||0,gradeMax:100,percentage:p||0,percentageMax:d}})},ae=async(a,e)=>{await H(a,e)},ne=async(a,e,n,r,o)=>{const c=`${I(a,e,n)}/assignments/${r}`,i=F(N,c);await Y(i,o)},re=async(a,e,n,r)=>{const o=Z(N);r.forEach(c=>{const{id:i,...m}=c,t=F(N,`${I(a,e,n)}/assignments/${i}`);o.update(t,m)}),await o.commit()},oe=async(a,e,n,r)=>{const o=F(N,`${I(a,e,n)}/assignments/${r}`);await ee(o)},ie=a=>{const{studentId:e,periodId:n,periodCourseId:r,courseId:o}=a,[c,i]=l.useState([]),[m,t]=l.useState(!1),[p,d]=l.useState(null),u=l.useCallback(async()=>{t(!0);try{const f=await te(e,n,r);i(f)}catch(f){d(f instanceof Error?f.message:"Error al cargar las calificaciones")}finally{t(!1)}},[e]);l.useEffect(()=>{u()},[e]);const x=l.useCallback(async()=>{t(!0);try{await ae(n,r)}catch(f){d(f instanceof Error?f.message:"Error adding assignment")}finally{t(!1)}},[e,n,o,u,t]),S=l.useCallback(async(f,h)=>{t(!0);try{if(r){const{percentage:g,grade:b}=h,y=(!g||g===0)&&b?E(h):Number(g),v={...h,grade:b!==void 0?Number(b):void 0,percentage:y};await ne(e,n,r,f,v)}else d("Course or course ID is missing");await u()}catch(g){console.error(g),d(g instanceof Error?g.message:"Error updating assignment")}finally{t(!1)}},[e,o,u,t]),A=l.useCallback(async f=>{t(!0);try{if(r){const h=U(f);h.length>0&&(await re(e,n,r,h),await u())}else d("Course or course ID is missing")}catch(h){d(h instanceof Error?h.message:"Error updating assignment")}finally{t(!1)}},[e,o,u,t]),j=l.useCallback(async f=>{t(!0);try{await oe(e,n,o,f),await u()}catch(h){d(h instanceof Error?h.message:"Error deleting assignment")}finally{t(!1)}},[e,o,u,t]),E=f=>{const{gradeMax:h,grade:g,percentageMax:b}=f;return g===100&&b?b:g/(h??100)*b},U=f=>{const h=[];return c&&c.map(g=>{const b=f[g.id];if(b){const{grade:y}=b;let v=g.percentage||0;console.log({"grade !== undefined":y!==void 0,"grade !== assignment.grade":y!==g.grade}),y!==void 0&&y!==g.grade&&(v=E({...g,...b})),h.push({...g,...b,percentage:v})}return g}),h};return{studentAssignment:c,loadAssignments:u,handleLoadAvalaibleAssignment:x,loading:m,error:p,handleUpdateAssignment:S,handleUpdateAssignments:A,handleDeleteAssignment:j}},ce=({studentId:a,periodId:e,periodCourseId:n,courseId:r})=>{const[o,c]=w("currentAssignment",null),{studentAssignment:i,loading:m,handleUpdateAssignment:t,handleUpdateAssignments:p}=ie({studentId:a,periodId:e,periodCourseId:n,courseId:r}),d=l.useMemo(()=>i.reduce((A,j)=>A+j.percentage,0),[i]),u=[{name:"title",placeholder:"Assignment"},{name:"percentage",placeholder:"Percentage",type:"number"},{name:"grade",placeholder:"Grade",type:"number"}],x=async A=>{console.log(A)},S=A=>p(A);return m?s.jsx(D,{type:"spinner",className:"item h30vh"}):s.jsx(s.Fragment,{children:s.jsxs("div",{className:"item",children:[s.jsx("div",{className:"container",children:s.jsxs("p",{children:[s.jsx("b",{children:"Total Percentage: "}),"(",d,")%"]})}),!m&&s.jsx(C,{title:"Student Assignments",alias:"AssignmentsManager",fields:u,items:i,ableFilter:!0,showForm:!1,ableForm:!0,initialFormData:o,loading:m,handlers:{onItemDeleted:x,onItemsUpdated:S,onItemUpdated:t,onSelect:c}})]})})},le=[{name:"identificationNumber",placeholder:"Identification"},{name:"email",placeholder:"Email Address"}],P=({student:a,onDelete:e})=>s.jsx(s.Fragment,{children:s.jsx(L,{titleName:"fullName",fields:le,data:a,handlers:{onDelete:e}})}),de=({periodCourse:a,periodId:e})=>{const{setIsLoading:n}=M(),{students:r,loading:o}=k(a),{handleDeleteCourse:c}=$(e),[i,m]=w("selectedStudent",null),t=[{name:"fullName",placeholder:"Full Name",view:!0},{name:"identificationNumber",placeholder:"Identification Number"},{name:"email",placeholder:"Email Address"},{name:"grade",placeholder:"grade",view:!0}],p=async d=>{await c(d,a.id,e)};return l.useEffect(()=>{n(o)},[o,n]),o?s.jsx(D,{type:"spinner",className:"item h30vh"}):s.jsxs("div",{children:[s.jsx("div",{className:"container px-0",children:s.jsxs(K.div,{className:"item",initial:{opacity:0,scale:0},animate:{opacity:1,scale:1},transition:{duration:.4,scale:{type:"spring",visualDuration:.4,bounce:.5}},children:[i&&s.jsx(P,{student:i}),i&&(i==null?void 0:i.id)&&a.id&&e&&s.jsx(ce,{studentId:i.id,periodId:e,courseId:a.courseId,periodCourseId:a.id})]})}),s.jsx(C,{title:"Students",alias:"CourseStudentsManager",fields:t,items:r,initialFormData:i,showForm:!1,ableForm:!1,ableFilter:!0,ableImport:!1,clearFormAfterAdd:!0,handlers:{onSelect:m,onItemDeleted:p},loading:o})]})},ue=({periodCourse:a,periodId:e})=>{const{setIsLoading:n}=M(),{availableStudents:r,loadAvailableStudents:o,loading:c,error:i}=k(a),{handleAddCourse:m}=$(e),[t,p]=l.useState(null);l.useEffect(()=>{o()},[a,o]);const d=[{name:"fullName",placeholder:"Full Name",view:!0},{name:"identificationNumber",placeholder:"Identification Number"},{name:"email",placeholder:"Email Address"}],u=async()=>{if(t&&a){const{id:x,courseId:S,name:A,description:j}=a,E={periodCourseId:x,courseId:S,periodId:e,name:A,description:j,status:"Not Started",finalGrade:0,assignmentsIds:[]};await m(t.id,E),await o()}};return l.useEffect(()=>{n(c)},[c,n]),s.jsxs("div",{className:"bt",children:[t&&s.jsx(P,{student:t}),t&&s.jsx("button",{className:"edit-button",onClick:u,children:"Assign course"}),s.jsx(C,{title:"Available Students",fields:d,items:r,showForm:!1,ableFilter:!0,ableForm:!1,ableImport:!1,clearFormAfterAdd:!0,handlers:{onSelect:p},loading:c}),i&&s.jsx("div",{className:"error",children:i})]})},me=({periodId:a,periodCourse:e})=>{const n=_(),[r,o]=w("activeSection","course"),c=[{name:"description",placeholder:"description"},{name:"duration",placeholder:"duration"},{name:"hours",placeholder:"hours"},{name:"status",placeholder:"status"},{name:"assignmentsIds",placeholder:"assignments",type:"array"},{name:"teacherName",placeholder:"teacherName"}],i=[{id:"assignments",label:"Course Assignments",icon:s.jsx(G,{})},{id:"students",label:"Enrolled Students",icon:s.jsx(B,{})},{id:"availableStudents",label:"Available Students",icon:s.jsx(W,{})}],m=t=>{o(t===r?"":t)};return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"container px-0",children:[s.jsxs("h1",{className:"title",children:[e==null?void 0:e.name," Course Manage"]}),s.jsxs("button",{onClick:()=>{n(-1)},children:[" ",s.jsx(R,{})," Go Back"]})]}),s.jsxs("div",{className:"actions-card",children:[s.jsx("div",{className:"view-toggle tabs",children:i.map(({id:t,label:p,icon:d})=>s.jsxs("button",{onClick:()=>m(t),className:`tab ${r===t?"active":""}`,children:[d," ",s.jsx("span",{className:"d-none d-md-block-over",children:p})]},t))}),s.jsx(L,{fields:c,data:e})]}),s.jsxs("div",{className:"container px-0",children:[r==="assignments"&&s.jsx(J,{course:e}),r==="students"&&s.jsx(de,{periodCourse:e,periodId:a}),r==="availableStudents"&&s.jsx(ue,{periodCourse:e,periodId:a})]})]})},Ie=()=>{const{periodId:a,courseId:e}=q(),{loading:n,course:r}=se(a,e);return s.jsx(s.Fragment,{children:!n&&r&&s.jsx(me,{periodId:a,periodCourse:r})})};export{Ie as default};
