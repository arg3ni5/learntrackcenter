import{d as m,u as P,j as g,L as C}from"./index-g1SReERP.js";import{r as u}from"./vendor-react-CrVlFZLu.js";import{D as S}from"./DataManagementModule-3FyRWLSI.js";import{_ as w,h as $,p as k,d as p,j as b,Q as R,y as N,q as L,W as M}from"./vendor-firebase-DPqF2cx7.js";const U=async(a,s)=>{const e=w(m,`periods/${a}/courses/${s}/assignments`);return(await $(e)).docs.map(o=>({id:o.id,...o.data()}))},q=async(a,s,e)=>{const i=w(m,`periods/${a}/courses/${s}/assignments`),c=await k(i,{...e}),o=p(m,`periods/${a}/courses/${s}`);await b(o,{assignmentsIds:R(c.id)})},F=async(a,s,e)=>{const i=M(m),c=w(m,`periods/${s}/courses/${e}/assignments`);a.forEach(o=>{const n=p(c);i.set(n,{title:o.title,contributionPercentage:o.contributionPercentage})});try{await i.commit()}catch(o){throw console.error("Error committing batch:",o),new Error("Error adding assignments")}},T=async(a,s,e,i,c)=>{const o=p(m,`periods/${a}/courses/${s}/assignments/${e}`),{id:n,...y}=i;await b(o,y)},Q=async(a,s,e)=>{const i=p(m,`periods/${a}/courses/${s}/assignments/${e}`);await N(i);const c=p(m,`periods/${a}`);await b(c,{assignmentsIds:L(s)})},W=async(a,s)=>{const e=w(m,`periods/${a}/courses/${s}/assignments`),c=(await $(e)).docs.map(n=>n.id),o=p(m,`periods/${a}/courses/${s}`);await b(o,{assignmentsIds:c})},_=a=>{const{courseId:s,periodId:e}=a,[i,c]=u.useState([]),[o,n]=u.useState(!1),[y,l]=u.useState(null),{showNotification:f}=P(),d=u.useCallback(async()=>{n(!0);try{const t=await U(e,s);c(t)}catch(t){l(t instanceof Error?t.message:"Error al cargar las calificaciones")}finally{n(!1)}},[e,s,n]);u.useEffect(()=>{let t=!0;return(async()=>{t&&await d()})(),()=>{t=!1}},[s,d]);const E=u.useCallback(async t=>{n(!0);try{const{id:r,link:h,...A}=t;await q(e,s,{...A,link:h||""}),await d()}catch(r){console.error("Error adding assignments:",r),l(r instanceof Error?r.message:"Error adding assignment")}finally{n(!1)}},[e,s,d,n]),x=async t=>{try{const r=t.filter(A=>!i.some(I=>I.title===A.title));if(r.length===0){f("All assignments already exist","error");return}if(r.filter(A=>!D(A)).length>0){f("Some assignments have invalid data","error");return}await F(r,e,s),f(`${r.length} assignments added`,"success"),d()}catch(r){console.error("Error adding assignments:",r),l("Error adding assignments")}},D=t=>i.some(h=>h.title===t.title)?(f("The assignment already exists","error"),!1):!t.title||typeof t.contributionPercentage!="number"||t.contributionPercentage<0||t.contributionPercentage>100?(f("Invalid assignment data","error"),!1):!0,j=u.useCallback(async(t,r)=>{n(!0);try{await T(e,s,t,r),await d()}catch(h){l(h instanceof Error?h.message:"Error updating assignment")}finally{n(!1)}},[e,s,d,n]),v=u.useCallback(async t=>{n(!0);try{await Q(e,s,t),await d()}catch(r){l(r instanceof Error?r.message:"Error deleting assignment")}finally{n(!1)}},[e,s,d,n]);return{assignments:i,loadAssignments:d,loading:o,setLoading:n,error:y,handleAddAssignment:E,handleAddAssignments:x,handleUpdateAssignment:j,handleDeleteAssignment:v,handleSyncAssignments:async()=>{try{if(!e||!s){l("Invalid period or course ID");return}n(!0),await W(e,s),await d()}catch{l("Error syncing assignments")}finally{n(!1)}}}},K=({course:a})=>{const{assignments:s,loading:e,error:i,handleAddAssignment:c,handleAddAssignments:o,handleDeleteAssignment:n,handleUpdateAssignment:y}=_({periodId:a.periodId,courseId:a.courseId}),l=u.useMemo(()=>s.reduce((d,E)=>d+(Number(E.contributionPercentage)||0),0),[s]),f=[{name:"title",placeholder:"Title of the assignment"},{name:"contributionPercentage",placeholder:"percentage",type:"number-view"},{name:"link",placeholder:"URL",type:"link",required:!1}];return e?g.jsx(C,{text:"Loading assignments",className:"h30vh"}):i?g.jsxs("div",{children:["Error: ",i]}):g.jsx("div",{className:"assignments-manager",children:g.jsx(S,{title:`${a.name} Assignments`,alias:a.courseId,fields:f,items:s,handlers:{onItemAdded:c,onItemUpdated:y,onItemDeleted:n,onItemsAdded:o},loading:e,clearFormAfterAdd:!1,showForm:!1,ableForm:!0,ableImport:!0,children:g.jsxs("div",{className:"container-grid",children:[g.jsxs("p",{children:[g.jsx("b",{children:"Total Percentage: "}),"(",l,")%"]}),l<100&&g.jsxs("p",{children:[g.jsx("b",{children:"Pending Percentage: "}),"(",100-l,")%"]})]})})})};export{K as C,U as f};
