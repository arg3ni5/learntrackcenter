import{r as l,a as T,o as w,f as B,h as E,k as G,x as R,l as C,y as z,z as H,m as O,j as s,L as F,D,C as M,e as L,A as q,u as J,F as K,B as Q,E as V,G as W,H as X,n as Y}from"./index-lcYHgldp.js";import{b as Z}from"./courseService-DwyhEZem.js";import{g as _,e as ee}from"./studentService-AsJdI5fo.js";import{u as $}from"./useStudentCourses-DEHyb5Gj.js";import"./periodService-CX19dkY2.js";const se=(a,e)=>{const[n,r]=l.useState(null),[c,i]=l.useState(!0),[o,m]=l.useState(null),{showNotification:t}=T(),[p]=w("availableTeachers",[]),d=async()=>{try{if(!e){console.error("Course ID is null or undefined");return}if(!a){console.error("Period ID is null or undefined");return}i(!0);const u=await Z(a,e);if(u){const A=p.find(S=>S.id===u.teacherId);u.teacherName=A?A.name:"Unassigned Teacher"}r(u)}catch{m("Error loading course"),t("Error loading course","error"),console.error(`Error loading course ${e}`)}finally{i(!1)}};return l.useEffect(()=>{d()},[]),{course:n,loading:c,error:o,setError:m}},k=a=>{const{id:e,periodId:n}=a,[r,c]=l.useState([]),[i,o]=l.useState([]),[m,t]=l.useState(!0),[p,d]=l.useState(null),u=async()=>{try{t(!0);const S=await _(n,e);c(S)}catch{d("Error loading getStudentsInCourse")}finally{t(!1)}},A=async()=>{try{t(!0);const S=await ee(n,e);o(S)}catch{d("Error loading students")}finally{t(!1)}};return l.useEffect(()=>{u()},[e]),{students:r,availableStudents:i,loadAvailableStudents:A,loading:m,error:p,loadStudents:u}},I=(a,e,n)=>`students/${a}/periods/${e}/courses/${n}`,te=async(a,e,n)=>{const r=`${I(a,e,n)}/assignments`,c=B(E,r);return(await G(c)).docs.map(o=>{const{title:m}=o.data(),{grade:t,percentage:p,percentageMax:d}=o.data();return{id:o.id,title:m,grade:t||0,gradeMax:100,percentage:p||0,percentageMax:d}})},ae=async(a,e)=>{await R(a,e)},ne=async(a,e,n,r,c)=>{const i=`${I(a,e,n)}/assignments/${r}`,o=C(E,i);await z(o,c)},re=async(a,e,n,r)=>{const c=H(E);r.forEach(i=>{const{id:o,...m}=i,t=C(E,`${I(a,e,n)}/assignments/${o}`);c.update(t,m)}),await c.commit()},oe=async(a,e,n,r)=>{const c=C(E,`${I(a,e,n)}/assignments/${r}`);await O(c)},ce=a=>{const{studentId:e,periodId:n,periodCourseId:r,courseId:c}=a,[i,o]=l.useState([]),[m,t]=l.useState(!1),[p,d]=l.useState(null),u=l.useCallback(async()=>{t(!0);try{const h=await te(e,n,r);o(h)}catch(h){d(h instanceof Error?h.message:"Error al cargar las calificaciones")}finally{t(!1)}},[e]);l.useEffect(()=>{u()},[e]);const A=l.useCallback(async()=>{t(!0);try{await ae(n,r)}catch(h){d(h instanceof Error?h.message:"Error adding assignment")}finally{t(!1)}},[e,n,c,u,t]),S=l.useCallback(async(h,f)=>{t(!0);try{if(r){const{percentage:g,grade:b}=f,y=(!g||g===0)&&b?j(f):Number(g),N={...f,grade:b!==void 0?Number(b):void 0,percentage:y};await ne(e,n,r,h,N)}else d("Course or course ID is missing");await u()}catch(g){console.error(g),d(g instanceof Error?g.message:"Error updating assignment")}finally{t(!1)}},[e,c,u,t]),v=l.useCallback(async h=>{t(!0);try{if(r){const f=U(h);f.length>0&&(await re(e,n,r,f),await u())}else d("Course or course ID is missing")}catch(f){d(f instanceof Error?f.message:"Error updating assignment")}finally{t(!1)}},[e,c,u,t]),x=l.useCallback(async h=>{t(!0);try{await oe(e,n,c,h),await u()}catch(f){d(f instanceof Error?f.message:"Error deleting assignment")}finally{t(!1)}},[e,c,u,t]),j=h=>{const{gradeMax:f,grade:g,percentageMax:b}=h;return g===100&&b?b:g/(f??100)*b},U=h=>{const f=[];return i&&i.map(g=>{const b=h[g.id];if(b){const{grade:y}=b;let N=g.percentage||0;console.log({"grade !== undefined":y!==void 0,"grade !== assignment.grade":y!==g.grade}),y!==void 0&&y!==g.grade&&(N=j({...g,...b})),f.push({...g,...b,percentage:N})}return g}),f};return{studentAssignment:i,loadAssignments:u,handleLoadAvalaibleAssignment:A,loading:m,error:p,handleUpdateAssignment:S,handleUpdateAssignments:v,handleDeleteAssignment:x}},ie=({studentId:a,periodId:e,periodCourseId:n,courseId:r})=>{const[c,i]=w("currentAssignment",null),{studentAssignment:o,loading:m,handleUpdateAssignment:t,handleUpdateAssignments:p}=ce({studentId:a,periodId:e,periodCourseId:n,courseId:r}),d=l.useMemo(()=>o.reduce((x,j)=>x+j.percentage,0),[o]),u=[{name:"title",placeholder:"Assignment"},{name:"percentage",placeholder:"Percentage",type:"number"},{name:"grade",placeholder:"Grade",type:"number"}],A=async x=>{console.log(x)},S=x=>{i(x)},v=x=>{p(x)};return m?s.jsx(F,{type:"spinner",className:"item h30vh"}):s.jsx(s.Fragment,{children:s.jsxs("div",{className:"item",children:[s.jsx("div",{className:"container",children:s.jsxs("p",{children:[s.jsx("b",{children:"Total Percentage: "}),"(",d,")%"]})}),!m&&s.jsx(D,{title:"Student Assignments",alias:"AssignmentsManager",fields:u,items:o,ableFilter:!0,showForm:!1,ableForm:!0,initialFormData:c,loading:m,handlers:{onItemUpdated:t,onItemDeleted:A,onSelect:S,onItemsUpdated:v}})]})})},le=[{name:"identificationNumber",placeholder:"Identification"},{name:"email",placeholder:"Email Address"}],P=({student:a,onDelete:e})=>s.jsx(s.Fragment,{children:s.jsx(M,{titleName:"fullName",fields:le,data:a,handlers:{onDelete:e}})}),de=({periodCourse:a,periodId:e})=>{const{setIsLoading:n}=L(),{students:r,loading:c}=k(a),{handleDeleteCourse:i}=$(e),[o,m]=w("selectedStudent",null),t=[{name:"fullName",placeholder:"Full Name",view:!0},{name:"identificationNumber",placeholder:"Identification Number"},{name:"email",placeholder:"Email Address"},{name:"grade",placeholder:"grade",view:!0}],p=async d=>{await i(d,a.id,e)};return l.useEffect(()=>{n(c)},[c,n]),c?s.jsx(F,{type:"spinner",className:"item h30vh"}):s.jsxs("div",{children:[s.jsx("div",{className:"container px-0",children:s.jsxs(q.div,{className:"item",initial:{opacity:0,scale:0},animate:{opacity:1,scale:1},transition:{duration:.4,scale:{type:"spring",visualDuration:.4,bounce:.5}},children:[o&&s.jsx(P,{student:o}),(o==null?void 0:o.id)&&a.id&&e&&s.jsx(ie,{studentId:o==null?void 0:o.id,periodId:e,courseId:a.courseId,periodCourseId:a.id})]})}),s.jsx(D,{title:"Students",alias:"CourseStudentsManager",fields:t,items:r,initialFormData:o,showForm:!1,ableForm:!1,ableFilter:!0,ableImport:!1,clearFormAfterAdd:!0,handlers:{onSelect:m,onItemDeleted:p},loading:c})]})},ue=({periodCourse:a,periodId:e})=>{const{setIsLoading:n}=L(),{availableStudents:r,loadAvailableStudents:c,loading:i,error:o}=k(a),{handleAddCourse:m}=$(e),[t,p]=l.useState(null);l.useEffect(()=>{c()},[]);const d=[{name:"fullName",placeholder:"Full Name",view:!0},{name:"identificationNumber",placeholder:"Identification Number"},{name:"email",placeholder:"Email Address"}],u=async()=>{if(t&&a){const{id:A,courseId:S,name:v,description:x}=a,j={periodCourseId:A,courseId:S,periodId:e,name:v,description:x,status:"Not Started",finalGrade:0,assignmentsIds:[]};await m(t.id,j),await c()}};return l.useEffect(()=>{n(i)},[i,n]),s.jsxs("div",{className:"bt",children:[t&&s.jsx(P,{student:t}),t&&s.jsx("button",{className:"edit-button",onClick:u,children:"Assign course"}),s.jsx(D,{title:"Available Students",fields:d,items:r,showForm:!1,ableFilter:!0,ableForm:!1,ableImport:!1,clearFormAfterAdd:!0,handlers:{onSelect:p},loading:i}),o&&s.jsx("div",{className:"error",children:o})]})},me=({periodId:a,periodCourse:e})=>{const n=J(),[r,c]=w("activeSection","course"),i=[{name:"description",placeholder:"description"},{name:"duration",placeholder:"duration"},{name:"hours",placeholder:"hours"},{name:"status",placeholder:"status"},{name:"assignmentsIds",placeholder:"assignments",type:"array"},{name:"teacherName",placeholder:"teacherName"}],o=[{id:"assignments",label:"Course Assignments",icon:s.jsx(V,{})},{id:"students",label:"Enrolled Students",icon:s.jsx(W,{})},{id:"availableStudents",label:"Available Students",icon:s.jsx(X,{})}],m=t=>{c(t===r?"":t)};return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"container px-0",children:[s.jsxs("h1",{className:"title",children:[e==null?void 0:e.name," Course Manage"]}),s.jsxs("button",{onClick:()=>{n(-1)},children:[" ",s.jsx(K,{})," Go Back"]})]}),s.jsxs("div",{className:"actions-card",children:[s.jsx("div",{className:"view-toggle tabs",children:o.map(({id:t,label:p,icon:d})=>s.jsxs("button",{onClick:()=>m(t),className:`tab ${r===t?"active":""}`,children:[d," ",s.jsx("span",{className:"d-none ",children:p})]},t))}),s.jsx(M,{fields:i,data:e})]}),s.jsxs("div",{className:"container px-0",children:[r==="assignments"&&s.jsx(Q,{course:e}),r==="students"&&s.jsx(de,{periodCourse:e,periodId:a}),r==="availableStudents"&&s.jsx(ue,{periodCourse:e,periodId:a})]})]})},xe=()=>{const{periodId:a,courseId:e}=Y(),{loading:n,course:r}=se(a,e);return s.jsx(s.Fragment,{children:!n&&r&&s.jsx(me,{periodId:a,periodCourse:r})})};export{xe as default};
